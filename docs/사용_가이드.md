# 일본 웹툰 랭킹 시스템 사용 가이드

## 빠른 시작

### 1️⃣ 초기 설정 (처음 한 번만)

```bash
# 1. 가상환경 생성
python3 -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 2. 패키지 설치
pip install -r requirements.txt
playwright install chromium

# 3. 리버스 작품 데이터 추출
python3 scripts/extract_riverse_titles.py

# 4. DB 초기화
python3 -c "from crawler.db import init_db; init_db()"
```

### 2️⃣ 일일 크롤링 실행

```bash
# 크롤러 실행 (5-10분 소요)
python3 crawler/main.py
```

**출력 예시:**
```
======================================================================
🚀 일본 웹툰 랭킹 크롤링 시작
📅 날짜: 2026-02-15
======================================================================

📱 픽코마 (SMARTOON) 크롤링 중...
   URL: https://piccoma.com/web/ranking/S/P/0
   ✅ 픽코마 (SMARTOON): 50개 작품 수집 완료

📱 라인망가 (웹 종합) 크롤링 중...
   URL: https://manga.line.me/periodic/gender_ranking?gender=0
   ✅ 라인망가 (웹 종합): 50개 작품 수집 완료

...

======================================================================
✅ 크롤링 완료
======================================================================
📊 성공: 4/4개 플랫폼
❌ 실패: 0/4개 플랫폼
```

### 3️⃣ 대시보드 열기

```bash
# 대시보드 실행
streamlit run dashboard/app.py

# 또는 간편 실행 스크립트:
./run_dashboard.sh  # Linux/Mac
run_dashboard.bat   # Windows
```

브라우저에서 자동으로 http://localhost:8501 오픈됩니다.

---

## 대시보드 사용법

### 📅 날짜 선택
- 상단 드롭다운에서 조회할 날짜 선택
- 요일도 함께 표시됨

### 🎯 플랫폼 탭
4개 탭으로 플랫폼별 랭킹 확인:
- 🔴 **픽코마 (SMARTOON)** - 스마툰 장르
- 🟢 **라인망가 (웹 종합)** - 웹 전체 순위
- 🔵 **메챠코믹 (판매)** - 판매 순위
- 🟡 **코믹시모아 (종합)** - 종합 순위

### ⭐ 리버스 작품 필터
- "리버스만 보기" 체크박스 활성화
- RIVERSE 작품만 필터링하여 표시
- 리버스 작품은 노란색 배경으로 하이라이트

### 📊 랭킹 테이블
| 컬럼 | 설명 |
|------|------|
| 순위 | 1~50위 |
| 제목 | 일본어 제목<br>(한국어 제목) |
| 장르 | 한국어 번역된 장르 |
| 순위변동 | ⬆️ 상승 / ⬇️ 하락 / 🆕 신규 / ➖ 변동없음 |
| 링크 | 🔗 클릭 시 해당 작품 페이지 오픈 |

### 📈 순위 변동 그래프 (핵심 기능!)

**사용법:**
1. 테이블 하단의 "작품 선택" 드롭다운 클릭
2. 관심 작품 선택
3. 최근 30일 순위 변동 그래프 자동 표시

**그래프 읽는 법:**
- X축: 날짜
- Y축: 순위 (1위가 위, 50위가 아래)
- 선이 **위로** 올라가면 순위 **상승** ⬆️
- 선이 **아래로** 내려가면 순위 **하락** ⬇️
- 마우스 호버로 정확한 날짜/순위 확인

**통계 요약:**
- 🏆 최고 순위: 해당 기간 중 최고 순위
- 📉 최저 순위: 해당 기간 중 최저 순위
- 📊 평균 순위: 기간 평균
- 📅 데이터 수: 수집된 일수

**주의:**
- 첫날은 히스토리 데이터가 없어 그래프 없음
- 2일차부터 그래프 생성 시작
- 매일 크롤링을 실행해야 그래프가 계속 쌓임

---

## 자동화 설정

### Cron (Linux/Mac)

매일 JST 09:00에 자동 실행:

```bash
crontab -e

# 추가:
0 9 * * * cd ~/webtoon-ranking && ~/webtoon-ranking/venv/bin/python3 crawler/main.py >> logs/cron.log 2>&1
```

### Windows 작업 스케줄러

1. 작업 스케줄러 열기 (`taskschd.msc`)
2. "기본 작업 만들기" 클릭
3. 트리거: 매일 09:00
4. 작업: 프로그램 시작
   - 프로그램: `C:\...\venv\Scripts\python.exe`
   - 인수: `crawler\main.py`
   - 시작 위치: `C:\...\webtoon_ranking_for_claude`

---

## 트러블슈팅

### ❌ IP 제한 오류

**증상:**
```
❌ piccoma 실패: 403 Client Error: Forbidden
💡 힌트: 일본 IP가 필요할 수 있습니다
```

**원인:**
- 픽코마, 라인망가는 일본 IP만 허용

**해결:**
1. 일본 VPN 연결 (예: ProtonVPN 일본 서버)
2. 또는 일본 사무실 서버에서 실행

### ❌ 라인망가 데이터 없음

**증상:**
- 작품 0개 수집

**원인:**
- CSR(Client-Side Rendering) 렌더링 대기 부족
- JavaScript가 로드되기 전에 크롤링 시도

**해결:**
- `linemanga.py`에서 `timeout` 값 증가:
  ```python
  await page.wait_for_selector('a[hint]', timeout=20000)  # 15초→20초
  ```

### 📭 대시보드에 데이터 없음

**증상:**
- "랭킹 데이터가 없습니다" 메시지

**원인:**
- 크롤링을 한 번도 실행하지 않음

**해결:**
```bash
python3 crawler/main.py
```

### 🐌 크롤링이 너무 느림

**정상 소요 시간:**
- 픽코마: 5초
- 라인망가: 30초 (무한 스크롤)
- 메챠코믹: 15초 (3페이지)
- 코믹시모아: 10초

**총 소요 시간: 약 1~2분**

네트워크 상태에 따라 더 걸릴 수 있습니다.

---

## 데이터 관리

### DB 위치
```
data/rankings.db
```

### JSON 백업
```
data/backup/
  ├── 2026-02-15/
  │   ├── piccoma.json
  │   ├── linemanga.json
  │   ├── mechacomic.json
  │   └── cmoa.json
  ├── 2026-02-16/
  ...
```

### DB 백업

```bash
# 전체 DB 복사
cp data/rankings.db data/rankings_backup_$(date +%Y%m%d).db

# 특정 날짜만 추출
sqlite3 data/rankings.db "
SELECT * FROM rankings
WHERE date = '2026-02-15'
" > rankings_20260215.csv
```

### 데이터 삭제

```bash
# 특정 날짜 삭제
sqlite3 data/rankings.db "
DELETE FROM rankings WHERE date = '2026-02-15'
"

# 전체 초기화
sqlite3 data/rankings.db "
DELETE FROM rankings
"
```

---

## FAQ

**Q1. 한 플랫폼만 크롤링할 수 있나요?**

A: 네, `crawler/platforms/` 각 파일을 직접 실행하면 됩니다.

```bash
python3 crawler/platforms/piccoma.py
```

**Q2. 50위 이상도 수집할 수 있나요?**

A: 각 플랫폼 크롤러의 `items[:50]` 부분을 수정하면 됩니다. 단, 일부 플랫폼은 50위까지만 제공합니다.

**Q3. 한국어 제목이 안 나와요.**

A: `data/title_mappings.json`에 수동으로 추가하거나, 리버스 작품은 `RIVERSE_統合コンテンツリスト.xlsx`에 추가 후 재추출하세요.

**Q4. 다른 장르 랭킹도 수집할 수 있나요?**

A: 각 플랫폼 크롤러의 URL을 변경하면 됩니다. 예:
```python
# linemanga.py
url = 'https://manga.line.me/periodic/gender_ranking?gender=1'  # 여성향
```

**Q5. 순위 변동 그래프가 안 보여요.**

A: 최소 2일 이상 크롤링 데이터가 누적되어야 그래프가 표시됩니다.

---

## 추가 개발 아이디어

- [ ] 순위 급상승/급하락 알림 (Slack/이메일)
- [ ] 경쟁사 작품 자동 추적
- [ ] 엑셀 다운로드 기능
- [ ] 주간/월간 리포트 자동 생성
- [ ] 다크 모드 지원
- [ ] 모바일 반응형 UI

---

**문의:** RIVERSE Inc. 기술팀
